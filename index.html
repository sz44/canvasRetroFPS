<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Document</title>
    </head>
    <body>
        <canvas></canvas>
        <script>
            const canvas = document.querySelector("canvas");
            const ctx = canvas.getContext("2d");
            canvas.width = 800;
            canvas.height = 600;

            const gridSize = 40;

            let run = true;

            let gridWidth = canvas.width / gridSize;
            let gridHeight = canvas.height / gridSize;

            let grid = Array(gridHeight * gridWidth).fill(0);

            let mapHeight = 16;
            let mapWidth = 16;

            let depth = 16;

            let playerX = 8;
            let playerY = 2;
            let playerA = 0;

            let FOV = Math.PI / 4;

            let mapa = [
                ["#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", "#"],
                ["#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#", "#"],
            ];

            let map = "";
            map += "################";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "#..............#";
            map += "################";

            let keys = new Set();

            let speed = 2;

            window.addEventListener("keydown", (e) => {
                keys.add(e.key);
            });

            window.addEventListener("keyup", (e) => {
                keys.delete(e.key);
            });

            // let wall = [200,100,400,400];
            // let wall = [200,200,400,200];

            function update() {
                if (keys.has("a")) {
                    // playerX -= speed;
                    playerA -= 0.1;
                }
                if (keys.has("d")) {
                    // playerX += speed;
                    playerA += 0.1;
                }
                if (keys.has("w")) {
                    // playerY -= speed;
                }
                if (keys.has("s")) {
                    // playerY += speed;
                }

                for (let x = 0; x < gridWidth; x++) {
                    let rayAngle = playerA - FOV / 2 + (x / gridWidth) * FOV;

                    let distanceToWall = 0;

                    let hitWall = false;

                    let eyeX = Math.sin(rayAngle);
                    let eyeY = Math.cos(rayAngle);

                    while (!hitWall && distanceToWall < depth) {
                        distanceToWall += 0.1;
                        let testX = Math.floor(playerX + eyeX * distanceToWall);
                        let testY = Math.floor(playerY + eyeY * distanceToWall);

                        if (testX < 0 || testX >= mapWidth || testY < 0 || testY >= mapHeight) {
                            hitWall = true;
                            distanceToWall = depth;
                        } else {
                            if (map[testY * mapWidth + testX] === "#") {
                                hitWall = true;
                            }
                        }
                    }

                    let ceiling = gridHeight / 2 - gridHeight / distanceToWall;
                    let floor = gridHeight - ceiling;

                    for (let y = 0; y < gridHeight; y++) {
                        if (y < ceiling) {
                            grid[y * gridWidth + x] = 0;
                        } else if (y > ceiling && y <= floor) {
                            grid[y * gridWidth + x] = 1;
                        } else {
                            grid[y * gridWidth + x] = 0;
                        }
                    }
                }
            }

            function draw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let y = 0; y < gridHeight; y++) {
                    for (let x = 0; x < gridWidth; x++) {
                        switch (grid[y * gridWidth + x]) {
                            case 0:
                                ctx.fillStyle = "#ffffff";
                                break;
                            case 1:
                                ctx.fillStyle = "#000000";
                                break;
                        }
                        ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
                    }
                }
                // ctx.beginPath();
                // ctx.fillStyle = "#790909";
                // ctx.strokeStyle = "#000000";
                // ctx.arc(playerX, playerY, 15, 0, Math.PI * 2);
                // ctx.rect(...wall)
                // ctx.fill();
                // ctx.stroke();
            }

            const FPS = 20;
            const frameTime = 1000 / FPS;

            let lastRun = 0;

            function main(time) {
                requestAnimationFrame(main);
                if ( run){
                    draw();
                    update();
                }

                // let timeElapsed = time - lastRun;
                // console.log(timeElapsed);
                // lastRun = time;

                // if (timeElapsed >= frameTime) {
                //     lastRun = time - (timeElapsed % frameTime);
                //     draw()
                //     update();
                // }
            }

            requestAnimationFrame(main);
        </script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }
            body {
                background: #292929;
                display: grid;
                place-items: center;
                height: 100vh;
            }
            canvas {
                background: white;
                border: 1px solid black;
                box-shadow: 5px 5px 5px black;
            }
        </style>
    </body>
</html>
